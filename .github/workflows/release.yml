name: Release

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      skip_release_please:
        description: "Skip release-please (use for manual rebuilds)"
        type: boolean
        default: false
      force_all:
        description: "Force build all components regardless of changes"
        type: boolean
        default: false

# Never cancel release workflow to ensure complete changelog
concurrency:
  group: release-please
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    name: Release Please
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'push' || !inputs.skip_release_please }}
    permissions:
      contents: write
      pull-requests: write
    outputs:
      # skillgen package outputs have skillgen-- prefix
      generator_release_created: ${{ steps.release.outputs['skillgen--release_created'] }}
      generator_tag_name: ${{ steps.release.outputs['skillgen--tag_name'] }}
      # Non-root packages have path prefix with --
      marketplace_release_created: ${{ steps.release.outputs['.claude-plugin--release_created'] }}
      marketplace_tag_name: ${{ steps.release.outputs['.claude-plugin--tag_name'] }}
      patterns_release_created: ${{ steps.release.outputs['skills/patterns--release_created'] }}
      patterns_tag_name: ${{ steps.release.outputs['skills/patterns--tag_name'] }}
      enforcement_release_created: ${{ steps.release.outputs['skills/enforce--release_created'] }}
      enforcement_tag_name: ${{ steps.release.outputs['skills/enforce--tag_name'] }}
      build_release_created: ${{ steps.release.outputs['skills/build--release_created'] }}
      build_tag_name: ${{ steps.release.outputs['skills/build--tag_name'] }}
      secure_release_created: ${{ steps.release.outputs['skills/secure--release_created'] }}
      secure_tag_name: ${{ steps.release.outputs['skills/secure--tag_name'] }}
      releases_created: ${{ steps.release.outputs.releases_created }}
    steps:
      # CRITICAL: GitHub App token required because GITHUB_TOKEN cannot trigger workflows
      # This ensures release-please can create PRs and releases with proper permissions
      - name: Generate AEL CORE App Token
        id: app_token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.CORE_APP_ID }}
          private-key: ${{ secrets.CORE_APP_PRIVATE_KEY }}
          owner: adaptive-enforcement-lab

      - name: Run release-please
        id: release
        uses: googleapis/release-please-action@v4
        with:
          token: ${{ steps.app_token.outputs.token }}
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

  dispatch-build:
    name: Dispatch Build Workflow
    needs: release-please
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # CRITICAL: GitHub App token required because GITHUB_TOKEN cannot trigger workflows
      # This ensures the Build Workflow is triggered when Release Workflow completes
      - name: Generate AEL CORE App Token
        id: generate_token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.CORE_APP_ID }}
          private-key: ${{ secrets.CORE_APP_PRIVATE_KEY }}
          owner: adaptive-enforcement-lab

      - name: Dispatch build workflow
        env:
          GH_TOKEN: ${{ steps.generate_token.outputs.token }}
          GENERATOR_TAG: ${{ needs.release-please.outputs.generator_tag_name }}
        run: |
          gh workflow run build.yml \
            --ref main \
            -f generator_is_release="${{ needs.release-please.outputs.generator_release_created == 'true' }}" \
            -f generator_tag_name="${GENERATOR_TAG}" \
            -f skip_build_version_tags="true" \
            -f triggered_by="release-workflow"

  announce-skills:
    name: Announce Skill Releases
    needs: release-please
    if: |
      needs.release-please.outputs.marketplace_release_created == 'true' ||
      needs.release-please.outputs.patterns_release_created == 'true' ||
      needs.release-please.outputs.enforcement_release_created == 'true' ||
      needs.release-please.outputs.build_release_created == 'true' ||
      needs.release-please.outputs.secure_release_created == 'true' ||
      (github.event_name == 'workflow_dispatch' && inputs.force_all == true)
    runs-on: ubuntu-latest
    steps:
      - name: Skills release notification
        env:
          MARKETPLACE_TAG: ${{ needs.release-please.outputs.marketplace_tag_name }}
          PATTERNS_TAG: ${{ needs.release-please.outputs.patterns_tag_name }}
          ENFORCEMENT_TAG: ${{ needs.release-please.outputs.enforcement_tag_name }}
          BUILD_TAG: ${{ needs.release-please.outputs.build_tag_name }}
          SECURE_TAG: ${{ needs.release-please.outputs.secure_tag_name }}
        run: |
          echo "Skills released:"
          [[ -n "$MARKETPLACE_TAG" ]] && echo "  - Marketplace catalog: $MARKETPLACE_TAG"
          [[ -n "$PATTERNS_TAG" ]] && echo "  - Patterns: $PATTERNS_TAG"
          [[ -n "$ENFORCEMENT_TAG" ]] && echo "  - Enforcement: $ENFORCEMENT_TAG"
          [[ -n "$BUILD_TAG" ]] && echo "  - Build: $BUILD_TAG"
          [[ -n "$SECURE_TAG" ]] && echo "  - Secure: $SECURE_TAG"
          echo ""
          echo "Install via: /plugin marketplace add adaptive-enforcement-lab/claude-skills"
